name: Build Universal LevelDB

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04 # 使用 22.04 以兼容旧版 NDK

    steps:
    # 1. 拉取代码 (不自动拉取子模块，后面手动修)
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: false

    # 2. 【核心修复】替换失效的子模块链接
    # 使用 JJJollyjim 的仓库，它是 Mojang 官方仓库最标准的备份
    - name: Fix Submodule URL
      run: |
        git submodule init
        git config submodule.library/src/main/jni/leveldb.url https://github.com/JJJollyjim/leveldb-mcpe.git
        git submodule update --init --recursive

    # 3. 自动修复 build.gradle 配置 (确保兼容 Android 5.0)
    - name: Fix Gradle Config
      run: |
        # 找到库的 build.gradle
        GRADLE_FILE=$(find . -name "build.gradle" | grep "library")
        
        if [ -n "$GRADLE_FILE" ]; then
            echo "Found gradle file: $GRADLE_FILE"
            # 这里的修复主要是确保环境能跑，具体架构由 NDK 决定
            # 老项目通常配置比较死，我们信赖下面的 NDK r21 环境
        else
            echo "Warning: library/build.gradle not found."
        fi

    # 4. 设置 JDK 1.8
    - name: Set up JDK 1.8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    # 5. 设置 Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 6. 【关键】安装 NDK r21 (LTS 版)
    # NDK r21 是编译老 C++ 代码并兼容 Android 5.0 的最佳选择
    - name: Install NDK r21
      run: |
        sdkmanager "ndk;21.4.7075529"

    # 7. 配置 local.properties
    - name: Configure NDK Path
      run: |
        echo "ndk.dir=$ANDROID_HOME/ndk/21.4.7075529" >> local.properties

    # 8. 赋予 Gradle 权限
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 9. 开始构建
    - name: Build Release
      run: ./gradlew assembleRelease --stacktrace

    # 10. 提取构建产物 (.jar 和 .so)
    - name: Extract Jar and Libs
      run: |
        mkdir -p output_files
        
        # 寻找生成的 aar 文件
        AAR_FILE=$(find . -name "*.aar" | grep "release" | head -n 1)
        
        if [ -z "$AAR_FILE" ]; then
            echo "Error: No .aar file found!"
            exit 1
        fi
        
        echo "Found AAR: $AAR_FILE"
        cp $AAR_FILE output_files/android-leveldb.aar
        
        # 解压提取内容
        unzip -q $AAR_FILE -d temp_extracted
        
        # 提取 jar
        if [ -f "temp_extracted/classes.jar" ]; then
            mv temp_extracted/classes.jar output_files/leveldb.jar
        fi
        
        # 提取 so 库 (这是重点，必须包含 arm64-v8a 和 armeabi-v7a)
        if [ -d "temp_extracted/jni" ]; then
            cp -r temp_extracted/jni output_files/libs
            
            # 检查架构是否齐全
            echo "Build Architectures:"
            ls output_files/libs
        fi

    # 11. 上传结果
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: LevelDB-Universal-Build
        path: output_files/
