name: Build Universal LevelDB

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. 拉取代码
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: false

    # 2. 修复子模块链接 (JJJollyjim)
    - name: Fix Submodule URL
      run: |
        git submodule init
        git config submodule.library/src/main/jni/leveldb.url https://github.com/JJJollyjim/leveldb-mcpe.git
        git submodule update --init --recursive

    # 3. 【关键步骤 A】先设置 Java 17
    # 这是为了让 Android SDK Manager (sdkmanager) 能正常运行
    # 如果不加这一步，sdkmanager 会因为检测到 Java 8 而报错退出
    - name: Set up JDK 17 for SDK Tools
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 4. 设置 Android SDK (此时环境是 Java 17，能成功)
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 5. 安装 NDK r21 (兼容老代码)
    - name: Install NDK r21
      run: |
        sdkmanager "ndk;21.4.7075529"

    # 6. 【关键步骤 B】再切换回 Java 8
    # 你的项目代码太老，必须用 Java 8 才能编译通过
    # 这一步会把 JAVA_HOME 重新指向 Java 8，供后面的 Gradle 使用
    - name: Set up JDK 8 for Build
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    # 7. 配置 local.properties
    - name: Configure NDK Path
      run: |
        echo "ndk.dir=$ANDROID_HOME/ndk/21.4.7075529" >> local.properties

    # 8. 赋予 Gradle 权限
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 9. 开始构建
    - name: Build Release
      run: ./gradlew assembleRelease --stacktrace

    # 10. 提取构建产物
    - name: Extract Jar and Libs
      run: |
        mkdir -p output_files
        
        # 寻找生成的 aar 文件
        AAR_FILE=$(find . -name "*.aar" | grep "release" | head -n 1)
        
        if [ -z "$AAR_FILE" ]; then
            echo "Error: No .aar file found!"
            exit 1
        fi
        
        echo "Found AAR: $AAR_FILE"
        cp $AAR_FILE output_files/android-leveldb.aar
        
        # 解压提取内容
        unzip -q $AAR_FILE -d temp_extracted
        
        # 提取 jar
        if [ -f "temp_extracted/classes.jar" ]; then
            mv temp_extracted/classes.jar output_files/leveldb.jar
        fi
        
        # 提取 so 库
        if [ -d "temp_extracted/jni" ]; then
            cp -r temp_extracted/jni output_files/libs
            echo "Build Architectures:"
            ls output_files/libs
        fi

    # 11. 上传结果
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: LevelDB-Universal-Build
        path: output_files/