name: Build Universal LevelDB

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    # 1. 拉取代码
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: false

    # 2. 修复子模块链接 (JJJollyjim)
    - name: Fix Submodule URL
      run: |
        git submodule init
        git config submodule.library/src/main/jni/leveldb.url https://github.com/JJJollyjim/leveldb-mcpe.git
        git submodule update --init --recursive

    # 3. 【核心修复】解锁 64位 (arm64-v8a) 支持
    # 老项目通常在 build.gradle 里写死了 abiFilters "armeabi-v7a"
    # 这里我们使用 sed 命令强行删除包含 'abiFilters' 的行
    # 删除后，Gradle 就会默认编译所有架构 (v7a, v8a, x86, x86_64)
    - name: Unlock 64-bit Support
      run: |
        echo "Searching for build.gradle files..."
        find . -name "build.gradle"
        
        # 对 library 目录下的 build.gradle 进行修改
        # 如果项目结构不同，这里会自动匹配所有 build.gradle
        # 只要行里包含 abiFilters，就直接删掉该行
        find . -name "build.gradle" -exec sed -i '/abiFilters/d' {} +
        
        echo "Successfully removed architecture restrictions. 64-bit should now build."

    # 4. 设置 JDK 17 (给 SDK Manager 用)
    - name: Set up JDK 17 for SDK Tools
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 5. 设置 Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 6. 安装 NDK r21 (兼容老代码)
    - name: Install NDK r21
      run: |
        sdkmanager "ndk;21.4.7075529"

    # 7. 设置 JDK 8 (给代码编译用)
    - name: Set up JDK 8 for Build
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'

    # 8. 配置 local.properties
    - name: Configure NDK Path
      run: |
        echo "ndk.dir=$ANDROID_HOME/ndk/21.4.7075529" >> local.properties

    # 9. 赋予 Gradle 权限
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 10. 开始构建
    - name: Build Release
      run: ./gradlew assembleRelease --stacktrace

    # 11. 提取构建产物
    - name: Extract Jar and Libs
      run: |
        mkdir -p output_files
        
        # 寻找生成的 aar 文件
        AAR_FILE=$(find . -name "*.aar" | grep "release" | head -n 1)
        
        if [ -z "$AAR_FILE" ]; then
            echo "Error: No .aar file found!"
            exit 1
        fi
        
        echo "Found AAR: $AAR_FILE"
        cp $AAR_FILE output_files/android-leveldb.aar
        
        # 解压提取内容
        unzip -q $AAR_FILE -d temp_extracted
        
        # 提取 jar
        if [ -f "temp_extracted/classes.jar" ]; then
            mv temp_extracted/classes.jar output_files/leveldb.jar
        fi
        
        # 提取 so 库
        if [ -d "temp_extracted/jni" ]; then
            cp -r temp_extracted/jni output_files/libs
            
            echo "---------------------------------------------------"
            echo "CHECKING ARCHITECTURES (You must see arm64-v8a here):"
            ls -R output_files/libs
            echo "---------------------------------------------------"
        else
            echo "Error: No JNI libs found in AAR!"
        fi

    # 12. 上传结果
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: LevelDB-Universal-Build
        path: output_files/